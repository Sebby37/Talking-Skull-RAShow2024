{"userHTML":"<div id=\"content\">\n    <div class=\"skullRow\">\n        <img class=\"skullDeco\" src=\"../Media/skull-gifs/skull.gif\" width=\"50\" height=\"50\">\n        <img class=\"skullDeco\" src=\"../Media/skull-gifs/skull.gif\" width=\"50\" height=\"50\">\n        <img class=\"skullDeco\" src=\"../Media/skull-gifs/skull.gif\" width=\"50\" height=\"50\">\n        <img class=\"skullDeco\" src=\"../Media/skull-gifs/skull.gif\" width=\"50\" height=\"50\">\n        <img class=\"skullDeco\" src=\"../Media/skull-gifs/skull.gif\" width=\"50\" height=\"50\">\n        <img src=\"https://raw.githubusercontent.com/Sebby37/Talking-Skull-RAShow2024/main/Media/logo.gif\" width=\"275\" height=\"69\">\n        <img class=\"skullDeco\" src=\"../Media/skull-gifs/skull.gif\" width=\"50\" height=\"50\">\n        <img class=\"skullDeco\" src=\"../Media/skull-gifs/skull.gif\" width=\"50\" height=\"50\">\n        <img class=\"skullDeco\" src=\"../Media/skull-gifs/skull.gif\" width=\"50\" height=\"50\">\n        <img class=\"skullDeco\" src=\"../Media/skull-gifs/skull.gif\" width=\"50\" height=\"50\">\n        <img class=\"skullDeco\" src=\"../Media/skull-gifs/skull.gif\" width=\"50\" height=\"50\">\n    </div>\n    <div id=\"bigCols\">\n        <div class=\"skullColumn\">\n            <img class=\"skullDeco\" src=\"../Media/skull-gifs/skull.gif\" width=\"50\" height=\"50\">\n            <img class=\"skullDeco\" src=\"../Media/skull-gifs/skull.gif\" width=\"50\" height=\"50\">\n            <img class=\"skullDeco\" src=\"../Media/skull-gifs/skull.gif\" width=\"50\" height=\"50\">\n            <img class=\"skullDeco\" src=\"../Media/skull-gifs/skull.gif\" width=\"50\" height=\"50\">\n            <img class=\"skullDeco\" src=\"../Media/skull-gifs/skull.gif\" width=\"50\" height=\"50\">\n            <img class=\"skullDeco\" src=\"../Media/skull-gifs/skull.gif\" width=\"50\" height=\"50\">\n            <img class=\"skullDeco\" src=\"../Media/skull-gifs/skull.gif\" width=\"50\" height=\"50\">\n        </div>\n        <table>\n            <tr>\n                <td>\n                    <h1>Live SKULL vision</h1>\n                    <video id=\"webcam\">Video stream not available.</video>\n                    <canvas id=\"screenie\" style=\"display:none\"></canvas>\n                </td>\n                <td>\n                    <div id=\"skullState\" class=\"skullInfo\">\n                        Loading\n                    </div>\n                    <img src=\"\" id=\"skullImg\" width=\"200\" height=\"200\">\n                    <p id=\"response\">...</p>\n                </td>\n            </tr>\n        </table>\n        <div class=\"skullColumn\">\n            <img class=\"skullDeco\" src=\"../Media/skull-gifs/skull.gif\" width=\"50\" height=\"50\">\n            <img class=\"skullDeco\" src=\"../Media/skull-gifs/skull.gif\" width=\"50\" height=\"50\">\n            <img class=\"skullDeco\" src=\"../Media/skull-gifs/skull.gif\" width=\"50\" height=\"50\">\n            <img class=\"skullDeco\" src=\"../Media/skull-gifs/skull.gif\" width=\"50\" height=\"50\">\n            <img class=\"skullDeco\" src=\"../Media/skull-gifs/skull.gif\" width=\"50\" height=\"50\">\n            <img class=\"skullDeco\" src=\"../Media/skull-gifs/skull.gif\" width=\"50\" height=\"50\">\n            <img class=\"skullDeco\" src=\"../Media/skull-gifs/skull.gif\" width=\"50\" height=\"50\">\n        </div>\n    </div>\n    <div class=\"skullRow\">\n        <img class=\"skullDeco\" src=\"../Media/skull-gifs/skull.gif\" width=\"50\" height=\"50\">\n        <img class=\"skullDeco\" src=\"../Media/skull-gifs/skull.gif\" width=\"50\" height=\"50\">\n        <img class=\"skullDeco\" src=\"../Media/skull-gifs/skull.gif\" width=\"50\" height=\"50\">\n        <img class=\"skullDeco\" src=\"../Media/skull-gifs/skull.gif\" width=\"50\" height=\"50\">\n        <img class=\"skullDeco\" src=\"../Media/skull-gifs/skull.gif\" width=\"50\" height=\"50\">\n        <img class=\"skullDeco\" src=\"../Media/skull-gifs/skull.gif\" width=\"50\" height=\"50\">\n        <img class=\"skullDeco\" src=\"../Media/skull-gifs/skull.gif\" width=\"50\" height=\"50\">\n        <img class=\"skullDeco\" src=\"../Media/skull-gifs/skull.gif\" width=\"50\" height=\"50\">\n        <img class=\"skullDeco\" src=\"../Media/skull-gifs/skull.gif\" width=\"50\" height=\"50\">\n        <img class=\"skullDeco\" src=\"../Media/skull-gifs/skull.gif\" width=\"50\" height=\"50\">\n        <img class=\"skullDeco\" src=\"../Media/skull-gifs/skull.gif\" width=\"50\" height=\"50\">\n        <img class=\"skullDeco\" src=\"../Media/skull-gifs/skull.gif\" width=\"50\" height=\"50\">\n        <img class=\"skullDeco\" src=\"../Media/skull-gifs/skull.gif\" width=\"50\" height=\"50\">\n        <img class=\"skullDeco\" src=\"../Media/skull-gifs/skull.gif\" width=\"50\" height=\"50\">\n        <img class=\"skullDeco\" src=\"../Media/skull-gifs/skull.gif\" width=\"50\" height=\"50\">\n    </div>\n</div>","userCSS":"body {\n    background-color: #323433;\n    color: white;\n    font-family: chilanka;\n}\n\ntable, tr, th, td {\n    border: 1px solid white;\n}\n\ntd {\n    width: 350px;\n    height: 350px;\n    text-align: center; \n    vertical-align: middle;\n}\n\n.skullInfo {\n    margin: auto;\n    margin-bottom: 15px;\n    margin-top: 15px;\n    \n    background-color: red;\n    outline: 2px solid white;\n    border: 2px solid black;\n    border-radius: 45px;\n    \n    width: 100px;\n    \n    padding: 10px;\n    padding-top: 15px;\n    padding-right: 20px;\n    \n    font-weight: bold;\n    font-size: 25px;\n}\n\n.skullColumn {\n    display: flex;\n    flex-direction: column;\n}\n\n#bigCols {\n    display: flex;\n    flex-direction: row;\n}","userJS":"// Skull Stuff\nlet canListen = true;\nlet listening = false;\nlet speaking = false;\nlet jawClosed = false;\n\nclass SkullStates {\n    static WAITING = \"Sleeping\";\n    static LISTENING = \"Listening\";\n    static THINKING = \"Thinking\";\n    static SPEAKING = \"Speaking\";\n}\n\n// Webcam stuff\nconst WIDTH = 320;\nlet height = 0; // Computed based on input stream\nlet streaming = false\nlet webcam = null;\n\n// Websocket stuff\nlet socket = null\nclass BoneCodes {\n    // Basically stuff the client sends\n    static START_RECORDING = \"START_RECORDING\";\n    static STOP_RECORDING = \"STOP_RECORDING\";\n    static SCREENIE = \"SCREENIE\";\n    \n    // Stuff server sends\n    static GENERATION_BEGIN = \"GENERATION_BEGIN\";\n    static GENERATION_COMPLETE = \"GENERATION_COMPLETE\";\n    static SPEAKING_END = \"SPEAKING_END\";\n}\nlet prevCommand = null;\n\nfunction setupVideo() {\n    webcam = document.getElementById(\"webcam\");\n    \n    navigator.mediaDevices\n        .getUserMedia({ video: true, audio: false })\n        .then((stream) => {\n            webcam.srcObject = stream;\n            webcam.play();\n        })\n        .catch((err) => {\n            console.error(\"Failed to start stream: \" + err)\n        });\n    \n    webcam.addEventListener(\"canplay\", (event) => {\n        if (streaming)\n            return;\n        \n        height = webcam.videoHeight / (webcam.videoWidth / WIDTH);\n        if (isNaN(height))\n            height = width / (4 / 3);\n        \n        webcam.setAttribute(\"width\", WIDTH)\n        webcam.setAttribute(\"height\", height)\n        \n        streaming = true;\n    }, false);\n}\n\nfunction takePicture() {\n    if (!streaming)\n        return null;\n    \n    let canvas = document.createElement(\"canvas\");\n    canvas.width = WIDTH;\n    canvas.height = height;\n    \n    let ctx = canvas.getContext(\"2d\");\n    ctx.drawImage(webcam, 0, 0, canvas.width, canvas.height);\n    \n    return canvas.toDataURL(\"image/png\")\n}\n\nfunction setupWebsocket() {\n    socket = new WebSocket(\"ws://192.168.20.3:8765\");\n    \n    socket.addEventListener(\"open\", (event) => {\n        console.log(\"Websocket opened!\", event);\n        socket.send(\"Smello!\");\n    });\n    \n    socket.addEventListener(\"message\", (event) => {\n        console.log(\"Message from server:\", event.data, event);\n        handleMessage(event.data);\n    });\n}\n\nfunction handleMessage(message) {\n    switch (message.split(\" \")[0]) {\n        case BoneCodes.GENERATION_BEGIN:\n            {\n                console.log(\"Generation has begun...\");\n                generationBegun();\n                break;\n            }\n        case BoneCodes.GENERATION_COMPLETE:\n            {\n                console.log(\"Generation complete! Got message:\", message);\n                generationComplete(message.slice(BoneCodes.GENERATION_COMPLETE.length + 1));\n                break;\n            }\n        case BoneCodes.SPEAKING_END:\n            {\n                console.log(\"Speaking has ended!\");\n                speakEnd();\n                break;\n            }\n    }\n}\n\nfunction startRecording() {\n    if (socket == null)\n        return;\n    \n    prevCommand = BoneCodes.START_RECORDING;\n    socket.send(BoneCodes.START_RECORDING);\n    setSkullState(SkullStates.LISTENING);\n    document.getElementById(\"response\").innerText = \"...\";\n}\n\nfunction stopRecording() {\n    if (socket == null)\n        return;\n    \n    prevCommand = BoneCodes.STOP_RECORDING;\n    socket.send(BoneCodes.STOP_RECORDING);\n}\n\nfunction sendScreenie() {\n    if (socket == null)\n        return;\n    \n    let screenie = takePicture();\n    \n    prevCommand = BoneCodes.SCREENIE;\n    socket.send(BoneCodes.SCREENIE + \" \" + screenie);\n}\n\nfunction generationBegun() {\n    // To be implemented moreso in runlinc\n    // But mainly frontend stuff I'd say\n    canListen = false;\n    setSkullState(SkullStates.THINKING);\n}\n\nfunction generationComplete(message) {\n    speaking = true;\n    setSkullState(SkullStates.SPEAKING);\n    document.getElementById(\"response\").innerText = JSON.parse(message).content;\n}\n\nfunction speakEnd() {\n    // Yet-again, a runlinc function moreso\n    // NOTE: servo value must be between 0 and 60, otherwise it flips itself off the skull lmao\n    speaking = false;\n    canListen = true;\n    setSkullState(SkullStates.WAITING);\n}\n\nfunction moveJaw() {\n    jawClosed = !jawClosed;\n    setServo(mouthServo, jawClosed ? 60 : 0);\n}\n\nfunction setSkullState(newState) {\n    // Set image\n    let skullImg = document.getElementById(\"skullImg\");\n    skullImg.src = `https://raw.githubusercontent.com/Sebby37/Talking-Skull-RAShow2024/main/Media/skull-${newState.toLowerCase()}.jpeg`\n    \n    // Set text\n    document.getElementById(\"skullState\").innerText = newState;\n}\n\nfunction loadSkullDecos() {\n    const skulls = [\"aniskull_Flee.gif\",\n        //\"arroba.gif\",\n        \"nurp-skullw.gif\",\n        \"skullcol.gif\",\n        \"skull_enter.gif\",\n        \"skull_flag.gif\",\n        \"skullflame.gif\",\n        \"skull.gif\",\n        \"skullspin.gif\", // I like this image, I want it to be more common :)\n        \"skullspin.gif\",\n        \"spinningskull.gif\"\n    ];\n    \n    let skullDecos = document.getElementsByClassName(\"skullDeco\");\n    for (const img of skullDecos) {\n        let chosenSkull = skulls[Math.floor(Math.random() * skulls.length)];\n        img.src = `https://raw.githubusercontent.com/Sebby37/Talking-Skull-RAShow2024/main/Media/skull-gifs/${chosenSkull}`;\n    }\n}\n\n// Run setups and such\nsetSkullState(SkullStates.WAITING);\nloadSkullDecos();\nsetupVideo();\nsetupWebsocket();","userJSLoop":"if (canListen) {\n  let buttonDown = (digitalIn(listenButton) == 1);\n  if (buttonDown && !listening) {\n    listening = true;\n    startRecording();\n  }\n  if (!buttonDown && listening) {\n    listening = false;\n    stopRecording();\n    sendScreenie();\n  }\n}\n\nif (speaking) {\n  moveJaw();\n  await mSec(250);\n}\n\nawait mSec(10);","boardName":"ESP32","userBoard":{"D2":{"options":["DISABLED","DIGITAL_OUT","PWM","SERVO","DIGITAL_IN"],"index":0,"name":"","value":0,"config":"DISABLED"},"D4":{"options":["DISABLED","DIGITAL_OUT","PWM","SERVO","DIGITAL_IN","DS18X20_IN"],"index":1,"name":"listenButton","value":0,"config":"DIGITAL_IN"},"D5":{"options":["DISABLED","DIGITAL_OUT","PWM","SERVO"],"index":2,"name":"","value":0,"config":"DISABLED"},"D12":{"options":["DISABLED","DIGITAL_OUT","PWM","SERVO"],"index":3,"name":"","value":0,"config":"DISABLED"},"D13":{"options":["DISABLED","DIGITAL_OUT","PWM","SERVO","DIGITAL_IN"],"index":4,"name":"","value":0,"config":"DISABLED"},"D14":{"options":["DISABLED","DIGITAL_OUT","PWM","SERVO"],"index":5,"name":"","value":0,"config":"DISABLED"},"D15":{"options":["DISABLED","DIGITAL_OUT","PWM","SERVO"],"index":6,"name":"","value":0,"config":"DISABLED"},"RX2":{"options":["DISABLED","DIGITAL_OUT","PWM","SERVO","DIGITAL_IN","GPS_IN","NPK_IN","TTY_IN"],"index":7,"name":"","value":0,"config":"DISABLED"},"TX2":{"options":["DISABLED","DIGITAL_OUT","PWM","SERVO","DIGITAL_IN","GPS_OUT","NPK_OUT","TTY_OUT"],"index":8,"name":"","value":0,"config":"DISABLED"},"D18":{"options":["DISABLED","DIGITAL_OUT","PWM","SERVO","DIGITAL_IN"],"index":9,"name":"","value":0,"config":"DISABLED"},"D19":{"options":["DISABLED","DIGITAL_OUT","PWM","SERVO","DIGITAL_IN"],"index":10,"name":"","value":0,"config":"DISABLED"},"D21":{"options":["DISABLED","DIGITAL_OUT","PWM","SERVO","DIGITAL_IN"],"index":11,"name":"","value":0,"config":"DISABLED"},"D22":{"options":["DISABLED","DIGITAL_OUT","PWM","SERVO","DIGITAL_IN"],"index":12,"name":"","value":0,"config":"DISABLED"},"D23":{"options":["DISABLED","DIGITAL_OUT","PWM","SERVO","DIGITAL_IN","DHT11_IN"],"index":13,"name":"","value":0,"config":"DISABLED"},"D25":{"options":["DISABLED","DIGITAL_OUT","PWM","SERVO","DIGITAL_IN"],"index":14,"name":"mouthServo","value":0,"config":"SERVO"},"D26":{"options":["DISABLED","DIGITAL_OUT","PWM","SERVO","DIGITAL_IN"],"index":15,"name":"","value":0,"config":"DISABLED"},"D27":{"options":["DISABLED","DIGITAL_OUT","PWM","SERVO","DIGITAL_IN"],"index":16,"name":"","value":0,"config":"DISABLED"},"D32":{"options":["DISABLED","DIGITAL_OUT","DIGITAL_IN","PWM","SERVO","ANALOG_IN"],"index":17,"name":"","value":0,"config":"DISABLED"},"D33":{"options":["DISABLED","DIGITAL_OUT","DIGITAL_IN","PWM","SERVO","ANALOG_IN"],"index":18,"name":"","value":0,"config":"DISABLED"},"D34":{"options":["DISABLED","DIGITAL_IN","ANALOG_IN"],"index":19,"name":"","value":0,"config":"DISABLED"},"D35":{"options":["DISABLED","DIGITAL_IN","ANALOG_IN"],"index":20,"name":"","value":0,"config":"DISABLED"},"VP":{"options":["DISABLED","DIGITAL_IN","ANALOG_IN"],"index":21,"name":"","value":0,"config":"DISABLED"},"RNG1":{"options":["DISABLED","ANALOG_IN"],"index":22,"name":"","value":0,"config":"DISABLED"},"RNG2":{"options":["DISABLED","ANALOG_IN"],"index":23,"name":"","value":0,"config":"DISABLED"},"VN":{"options":["DISABLED","DIGITAL_IN","ANALOG_IN"],"index":24,"name":"","value":0,"config":"DISABLED"}},"boardIP":"http://192.168.20.80"}